<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: right;
        }

        /* Login Screen Styles */
        .login-screen {
            text-align: center;
        }

        .login-screen h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .input-group {
            width: 100%;
            max-width: 300px;
        }

        .input-group label {
            display: block;
            text-align: right;
            margin-bottom: 8px;
            color: #666;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            text-align: right;
            direction: rtl;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-button {
            padding: 12px 40px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-button:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 10px;
        }

        /* User Info Header */
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            direction: rtl;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info-text {
            font-size: 14px;
            color: #666;
        }

        .user-name {
            font-weight: 600;
            color: #333;
        }

        .logout-button {
            padding: 6px 12px;
            background: #fee2e2;
            color: #ef4444;
            border: 1px solid #fca5a5;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-button:hover {
            background: #ef4444;
            color: white;
        }

        /* Rakaz Selector */
        .katagis-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            direction: rtl;
        }

        .katagis-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .katagis-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            text-align: right;
            direction: rtl;
        }

        /* Admin View Enhancements */
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            direction: rtl;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 10px;
        }

        .view-toggle button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: #666;
        }

        .view-toggle button.active {
            background: #667eea;
            color: white;
        }

        .tzevet-section {
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            background: #f8f9fa;
        }

        .tzevet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            direction: rtl;
        }

        .tzevet-name {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .tzevet-stats {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #666;
        }

        .stat-item {
            background: white;
            padding: 5px 12px;
            border-radius: 8px;
            font-weight: 600;
        }

        .admin-list {
            direction: rtl;
            display: grid;
            gap: 12px;
        }

        .admin-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-item:hover {
            border-color: #667eea;
            transform: translateX(-5px);
        }

        .admin-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .admin-item-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .admin-item-id {
            font-size: 12px;
            color: #999;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .admin-progress {
            font-size: 14px;
            color: #666;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            margin-top: 30px;
            direction: rtl;
        }

        .section-header h3 {
            color: #333;
            font-size: 18px;
        }

        .count-badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .checklist-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            direction: rtl;
        }

        .checklist-item.completed {
            background: #f0f9ff;
            border-color: #10b981;
        }

        .checklist-content {
            flex: 1;
            text-align: right;
        }

        .checklist-title {
            color: #333;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .checklist-item.completed .checklist-title {
            color: #10b981;
            text-decoration: line-through;
        }

        .progress-bar-container {
            background: #e0e0e0;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .check-button {
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .check-button:hover:not(:disabled) {
            background: #5568d3;
            transform: scale(1.05);
        }

        .check-button:disabled {
            background: #10b981;
            cursor: not-allowed;
        }

        .reset-button {
            padding: 6px 12px;
            background: #fee2e2;
            color: #ef4444;
            border: 1px solid #fca5a5;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reset-button:hover {
            background: #ef4444;
            color: white;
        }

        .overall-progress {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            direction: rtl;
        }

        .overall-progress-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .overall-progress-bar-container {
            background: #e0e0e0;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }

        .overall-progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        /* Back Button */
        .back-button {
            padding: 8px 16px;
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .back-button:hover {
            background: #d0d0d0;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .summary-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-card-label {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <h2>התחברות למערכת</h2>
            <div class="login-form">
                <div class="input-group">
                    <label for="userId">מספר מזהה</label>
                    <input type="text" id="userId" placeholder="הכנס מספר מזהה">
                </div>
                <button class="login-button" onclick="login()">התחבר</button>
                <div id="loginError" class="error-message hidden"></div>
            </div>
        </div>

        <!-- Main Content (hidden initially) -->
        <div id="mainContent" class="hidden">
            <!-- User Info Header -->
            <div class="user-info">
                <div class="user-info-text">
                    שלום, <span class="user-name" id="userName"></span>
                    <span id="roleText"></span>
                </div>
            </div>

            <!-- Katagis View -->
            <div id="katagisView" class="hidden">
                <h1>מעקב משימות</h1>
                <div class="section-header">
                    <h3>ההתנסות שלי</h3>
                    <span class="count-badge" id="checklistCount">0</span>
                </div>
                <div class="overall-progress">
                    <div class="overall-progress-label">התקדמות כללית: <span id="overallProgressText">0%</span></div>
                    <div class="overall-progress-bar-container">
                        <div class="overall-progress-bar" id="overallProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div id="checklistItems"></div>
            </div>

            <!-- Rakaz View -->
            <div id="rakazView" class="hidden">
                <h1>ניהול צוות</h1>
                <div class="katagis-selector">
                    <label>בחר מתנסה:</label>
                    <select id="katagisSelect" onchange="loadSelectedKatagis()">
                        <option value="">-- בחר מתנסה --</option>
                    </select>
                </div>
                <div id="rakazChecklistView" class="hidden">
                    <div class="section-header">
                        <h3>התנסות של <span id="selectedKatagisName"></span></h3>
                        <span class="count-badge" id="rakazChecklistCount">0</span>
                    </div>
                    <div class="overall-progress">
                        <div class="overall-progress-label">התקדמות כללית: <span id="rakazOverallProgressText">0%</span></div>
                        <div class="overall-progress-bar-container">
                            <div class="overall-progress-bar" id="rakazOverallProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="rakazChecklistItems"></div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="hidden">
                <h1>תצוגת מנהל</h1>
                
                <!-- Admin Controls -->
                <div class="admin-controls">
                    <div class="view-toggle">
                        <button onclick="setAdminView('overview')" class="active" id="overviewBtn">סקירה כללית</button>
                        <button onclick="setAdminView('tzevet')" id="tzevetBtn">לפי צוותים</button>
                        <button onclick="setAdminView('all')" id="allBtn">כל המתנסים</button>
                    </div>
                </div>

                <!-- Overview View -->
                <div id="adminOverview">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-card-value" id="totalKatagis">0</div>
                            <div class="summary-card-label">סך מתנסים</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-value" id="totalTzvatim">0</div>
                            <div class="summary-card-label">סך צוותים</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-value" id="avgProgress">0%</div>
                            <div class="summary-card-label">התקדמות ממוצעת</div>
                        </div>
                    </div>
                    <div id="overviewContent"></div>
                </div>

                <!-- Tzevet View -->
                <div id="adminTzevetView" class="hidden">
                    <div id="tzevetContent"></div>
                </div>

                <!-- All Katagis View -->
                <div id="adminAllView" class="hidden">
                    <div id="adminKatagisList" class="admin-list"></div>
                </div>

                <!-- Detail View -->
                <div id="adminDetailView" class="hidden">
                    <button class="back-button" onclick="backFromAdminDetail()">← חזור</button>
                    <div class="section-header">
                        <h3>התנסות של <span id="adminSelectedName"></span></h3>
                        <span class="count-badge" id="adminChecklistCount">0</span>
                    </div>
                    <div class="overall-progress">
                        <div class="overall-progress-label">התקדמות כללית: <span id="adminOverallProgressText">0%</span></div>
                        <div class="overall-progress-bar-container">
                            <div class="overall-progress-bar" id="adminOverallProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="adminChecklistItems"></div>
                </div>
            </div>
        </div>

        <div id="loadingMessage" class="loading hidden">טוען...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        const firebaseConfig = {
            authDomain: "tzita-9a1b5.firebaseapp.com",
            databaseURL: "https://tzita-9a1b5-default-rtdb.firebaseio.com",
            projectId: "tzita-9a1b5",
            appId: "1:43152262444:web:e8aa6e7d7fbb99ff9b5889",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const missions = ["C001", "C002", "C003", "C004", "C005", "C006", "C007", "C008", "C009", "C010", "C011", "C012", "C013", "C014", "C015", "C016"];
        
        const missionDetails = {
            "C001": { title: "להשתתף בישבץ", total: 3 },
            "C002": { title: "לעשות צפי עם המדריך", total: 4 },
            "C003": { title: "להעביר צפי לבד", total: 1 },
            "C004": { title: "להפגש עם המדריך לכתוב פעולה", total: 4 },
            "C005": { title: "להעביר משחק פתיחה", total: 3 },
            "C006": { title: "להיות בהורדת סירות", total: 6 },
            "C007": { title: "להיות בהרמת סירות וחיסולים", total: 5 },
            "C008": { title: "להעביר זמן תוכן", total: 1 },
            "C009": { title: "להעביר דיון", total: 1 },
            "C010": { title: "להעביר שיחת סיכום", total: 1 },
            "C011": { title: "להיות אחראי על הכנת סירה", total: 2 },
            "C012": { title: "לעשות יציאה מהמזח", total: 2 },
            "C013": { title: "לפקד על עגינה", total: 2 },
            "C014": { title: "להעביר משחק בסירה/לפקד", total: 2 },
            "C015": { title: "להיקשר למזח", total: 2 },
            "C016": { title: "להיות אחראי על חיסול סירה", total: 2 }
        };

        let currentUser = null;
        let selectedKatagisId = null;
        let allKatagisData = null;
        let allRakazData = null;
        let currentAdminView = 'overview';
        let previousAdminView = 'overview';

        // Local storage for user ID
        const STORAGE_KEY = 'currentUserId';

        // Initialize app
        async function init() {
            const storedId = localStorage.getItem(STORAGE_KEY);
            if (storedId) {
                await attemptLogin(storedId);
            } else {
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        window.login = async function() {
            const userId = document.getElementById('userId').value.trim();
            if (!userId) {
                showError('אנא הכנס מספר מזהה');
                return;
            }
            await attemptLogin(userId);
        };

        async function attemptLogin(userId) {
            showLoading(true);
            hideError();
            
            try {
                const userData = await getIdData(userId);
                
                if (!userData) {
                    showError('מספר מזהה לא נמצא במערכת');
                    showLoading(false);
                    showLoginScreen();
                    return;
                }

                currentUser = {
                    id: userId,
                    ...userData
                };

                localStorage.setItem(STORAGE_KEY, userId);
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                showUserView();
                showLoading(false);
            } catch (error) {
                console.error('Login error:', error);
                showError('שגיאה בהתחברות למערכת');
                showLoading(false);
                showLoginScreen();
            }
        };

        window.logout = function() {
            localStorage.removeItem(STORAGE_KEY);
            currentUser = null;
            selectedKatagisId = null;
            showLoginScreen();
        };

        async function getIdData(id) {
            const snapshot = await get(ref(db, id.toString()));
            return snapshot.exists() ? snapshot.val() : null;
        }

        function showUserView() {
            document.getElementById('userName').textContent = currentUser.name;
            
            // Hide all views
            document.getElementById('katagisView').classList.add('hidden');
            document.getElementById('rakazView').classList.add('hidden');
            document.getElementById('adminView').classList.add('hidden');

            if (currentUser.role === 'katagis') {
                document.getElementById('roleText').textContent = '(מתנסה)';
                document.getElementById('katagisView').classList.remove('hidden');
                displayKatagisChecklist();
            } else if (currentUser.role === 'rakaz') {
                document.getElementById('roleText').textContent = '(רכ"ז)';
                document.getElementById('rakazView').classList.remove('hidden');
                loadRakazTzevet();
            } else if (currentUser.role === 'admin') {
                document.getElementById('roleText').textContent = '(מנהל)';
                document.getElementById('adminView').classList.remove('hidden');
                loadAllData();
            }
        }

        // KATAGIS VIEW - Read Only
        async function displayKatagisChecklist() {
            const checklistDiv = document.getElementById('checklistItems');
            checklistDiv.innerHTML = '';

            missions.forEach(missionId => {
                const current = currentUser.status[missionId] || 0;
                const total = missionDetails[missionId].total;
                const title = missionDetails[missionId].title;
                const isCompleted = current >= total;
                const percentage = (current / total) * 100;

                const div = document.createElement('div');
                div.className = `checklist-item ${isCompleted ? 'completed' : ''}`;
                div.innerHTML = `
                    <div class="checklist-content">
                        <div class="checklist-title">${title}</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${percentage}%; ${isCompleted ? 'background: #10b981;' : ''}"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ${current} / ${total} ${isCompleted ? '✓ הושלם' : ''}
                        </div>
                    </div>
                `;
                checklistDiv.appendChild(div);
            });

            updateOverallProgress('katagis', currentUser.status);
        }

        // RAKAZ VIEW
        async function loadRakazTzevet() {
            const select = document.getElementById('katagisSelect');
            select.innerHTML = '<option value="">-- בחר מתנסה --</option>';

            if (!currentUser.tzevet) return;

            for (const katagisId in currentUser.tzevet) {
                const katagisData = await getIdData(katagisId);
                if (katagisData && katagisData.role === 'katagis') {
                    const option = document.createElement('option');
                    option.value = katagisId;
                    option.textContent = katagisData.name;
                    select.appendChild(option);
                }
            }
        }

        window.loadSelectedKatagis = async function() {
            const select = document.getElementById('katagisSelect');
            selectedKatagisId = select.value;

            if (!selectedKatagisId) {
                document.getElementById('rakazChecklistView').classList.add('hidden');
                return;
            }

            const katagisData = await getIdData(selectedKatagisId);
            if (!katagisData) return;

            document.getElementById('selectedKatagisName').textContent = katagisData.name;
            document.getElementById('rakazChecklistView').classList.remove('hidden');
            
            displayRakazChecklist(katagisData.status);
        };

        function displayRakazChecklist(status) {
            const checklistDiv = document.getElementById('rakazChecklistItems');
            checklistDiv.innerHTML = '';

            missions.forEach((missionId, index) => {
                const current = status[missionId] || 0;
                const total = missionDetails[missionId].total;
                const title = missionDetails[missionId].title;
                const isCompleted = current >= total;
                const percentage = (current / total) * 100;

                const div = document.createElement('div');
                div.className = `checklist-item ${isCompleted ? 'completed' : ''}`;
                div.innerHTML = `
                    <div class="checklist-content">
                        <div class="checklist-title">${title}</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${percentage}%; ${isCompleted ? 'background: #10b981;' : ''}"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ${current} / ${total} ${isCompleted ? '✓ הושלם' : ''}
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="check-button" onclick="incrementRakazProgress('${missionId}')" ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? 'הושלם' : '+ סימון'}
                        </button>
                        <button class="reset-button" onclick="resetRakazTask('${missionId}')">
                            איפוס
                        </button>
                    </div>
                `;
                checklistDiv.appendChild(div);
            });

            updateOverallProgress('rakaz', status);
        }

        window.incrementRakazProgress = async function(missionId) {
            if (!selectedKatagisId) return;

            const katagisData = await getIdData(selectedKatagisId);
            const current = katagisData.status[missionId] || 0;
            const total = missionDetails[missionId].total;

            if (current < total) {
                const updates = {};
                updates[`${selectedKatagisId}/status/${missionId}`] = current + 1;
                await update(ref(db), updates);
                loadSelectedKatagis();
            }
        };

        window.resetRakazTask = async function(missionId) {
            if (!selectedKatagisId) return;

            const title = missionDetails[missionId].title;
            if (confirm(`האם לאפס את ההתקדמות במשימה: "${title}"?`)) {
                const updates = {};
                updates[`${selectedKatagisId}/status/${missionId}`] = 0;
                await update(ref(db), updates);
                loadSelectedKatagis();
            }
        };

        // ADMIN VIEW
        async function loadAllData() {
            showLoading(true);
            const snapshot = await get(ref(db));
            allKatagisData = {};
            allRakazData = {};

            if (snapshot.exists()) {
                const data = snapshot.val();
                for (const userId in data) {
                    if (data[userId].role === 'katagis') {
                        allKatagisData[userId] = data[userId];
                    } else if (data[userId].role === 'rakaz') {
                        allRakazData[userId] = data[userId];
                    }
                }
            }

            setAdminView(currentAdminView);
            showLoading(false);
        }

        window.setAdminView = function(view) {
            currentAdminView = view;
            
            // Update button states
            document.getElementById('overviewBtn').classList.toggle('active', view === 'overview');
            document.getElementById('tzevetBtn').classList.toggle('active', view === 'tzevet');
            document.getElementById('allBtn').classList.toggle('active', view === 'all');

            // Show/hide views
            document.getElementById('adminOverview').classList.toggle('hidden', view !== 'overview');
            document.getElementById('adminTzevetView').classList.toggle('hidden', view !== 'tzevet');
            document.getElementById('adminAllView').classList.toggle('hidden', view !== 'all');
            document.getElementById('adminDetailView').classList.add('hidden');

            if (view === 'overview') {
                displayAdminOverview();
            } else if (view === 'tzevet') {
                displayAdminTzevetView();
            } else if (view === 'all') {
                displayAdminAllView();
            }
        };

        function displayAdminOverview() {
            const totalKatagis = Object.keys(allKatagisData).length;
            const totalTzvatim = Object.keys(allRakazData).length;
            
            let totalProgress = 0;
            for (const userId in allKatagisData) {
                totalProgress += calculateProgress(allKatagisData[userId].status);
            }
            const avgProgress = totalKatagis > 0 ? Math.round(totalProgress / totalKatagis) : 0;

            document.getElementById('totalKatagis').textContent = totalKatagis;
            document.getElementById('totalTzvatim').textContent = totalTzvatim;
            document.getElementById('avgProgress').textContent = avgProgress + '%';

            // Show quick stats by tzevet
            const overviewContent = document.getElementById('overviewContent');
            overviewContent.innerHTML = '';

            for (const rakazId in allRakazData) {
                const rakaz = allRakazData[rakazId];
                const tzevetKatagis = [];
                let tzevetTotalProgress = 0;

                if (rakaz.tzevet) {
                    for (const katagisId in rakaz.tzevet) {
                        if (allKatagisData[katagisId]) {
                            tzevetKatagis.push({
                                id: katagisId,
                                ...allKatagisData[katagisId]
                            });
                            tzevetTotalProgress += calculateProgress(allKatagisData[katagisId].status);
                        }
                    }
                }

                const avgTzevetProgress = tzevetKatagis.length > 0 ? 
                    Math.round(tzevetTotalProgress / tzevetKatagis.length) : 0;

                const div = document.createElement('div');
                div.className = 'admin-item';
                div.onclick = () => {
                    previousAdminView = 'overview';
                    setAdminView('tzevet');
                    // Scroll to tzevet section would be ideal here
                };
                div.innerHTML = `
                    <div class="admin-item-header">
                        <div class="admin-item-name">צוות ${rakaz.name}</div>
                        <div class="admin-item-id">${tzevetKatagis.length} מתנסים</div>
                    </div>
                    <div class="admin-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${avgTzevetProgress}%"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            התקדמות ממוצעת: ${avgTzevetProgress}%
                        </div>
                    </div>
                `;
                overviewContent.appendChild(div);
            }
        }

        function displayAdminTzevetView() {
            const tzevetContent = document.getElementById('tzevetContent');
            tzevetContent.innerHTML = '';

            for (const rakazId in allRakazData) {
                const rakaz = allRakazData[rakazId];
                const tzevetKatagis = [];
                let tzevetTotalProgress = 0;
                let completedTasks = 0;
                let totalTasks = 0;

                if (rakaz.tzevet) {
                    for (const katagisId in rakaz.tzevet) {
                        if (allKatagisData[katagisId]) {
                            const katagis = allKatagisData[katagisId];
                            tzevetKatagis.push({
                                id: katagisId,
                                ...katagis
                            });
                            tzevetTotalProgress += calculateProgress(katagis.status);
                            
                            // Count completed tasks
                            missions.forEach(missionId => {
                                const current = katagis.status[missionId] || 0;
                                const total = missionDetails[missionId].total;
                                totalTasks += total;
                                completedTasks += current;
                            });
                        }
                    }
                }

                const avgTzevetProgress = tzevetKatagis.length > 0 ? 
                    Math.round(tzevetTotalProgress / tzevetKatagis.length) : 0;

                const tzevetSection = document.createElement('div');
                tzevetSection.className = 'tzevet-section';
                tzevetSection.innerHTML = `
                    <div class="tzevet-header">
                        <div class="tzevet-name">צוות ${rakaz.name}</div>
                        <div class="tzevet-stats">
                            <div class="stat-item">${tzevetKatagis.length} מתנסים</div>
                            <div class="stat-item">${completedTasks} / ${totalTasks} משימות</div>
                            <div class="stat-item">${avgTzevetProgress}% ממוצע</div>
                        </div>
                    </div>
                    <div class="admin-list" id="tzevet-${rakazId}"></div>
                `;
                tzevetContent.appendChild(tzevetSection);

                const listDiv = tzevetSection.querySelector(`#tzevet-${rakazId}`);
                tzevetKatagis.forEach(katagis => {
                    const progress = calculateProgress(katagis.status);
                    const div = document.createElement('div');
                    div.className = 'admin-item';
                    div.onclick = () => showAdminDetail(katagis.id);
                    div.innerHTML = `
                        <div class="admin-item-header">
                            <div class="admin-item-name">${katagis.name}</div>
                            <div class="admin-item-id">${katagis.id}</div>
                        </div>
                        <div class="admin-progress">
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                התקדמות: ${progress}%
                            </div>
                        </div>
                    `;
                    listDiv.appendChild(div);
                });
            }
        }

        function displayAdminAllView() {
            const listDiv = document.getElementById('adminKatagisList');
            listDiv.innerHTML = '';

            for (const userId in allKatagisData) {
                const katagis = allKatagisData[userId];
                const progress = calculateProgress(katagis.status);

                const div = document.createElement('div');
                div.className = 'admin-item';
                div.onclick = () => showAdminDetail(userId);
                div.innerHTML = `
                    <div class="admin-item-header">
                        <div class="admin-item-name">${katagis.name}</div>
                        <div class="admin-item-id">${userId}</div>
                    </div>
                    <div class="admin-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            התקדמות כללית: ${progress}%
                        </div>
                    </div>
                `;
                listDiv.appendChild(div);
            }
        }

        window.showAdminDetail = function(userId) {
            previousAdminView = currentAdminView;
            selectedKatagisId = userId;
            const katagis = allKatagisData[userId];

            document.getElementById('adminOverview').classList.add('hidden');
            document.getElementById('adminTzevetView').classList.add('hidden');
            document.getElementById('adminAllView').classList.add('hidden');
            document.getElementById('adminDetailView').classList.remove('hidden');
            document.getElementById('adminSelectedName').textContent = katagis.name;

            displayAdminChecklist(katagis.status);
        };

        window.backFromAdminDetail = function() {
            selectedKatagisId = null;
            setAdminView(previousAdminView);
        };

        function displayAdminChecklist(status) {
            const checklistDiv = document.getElementById('adminChecklistItems');
            checklistDiv.innerHTML = '';

            missions.forEach(missionId => {
                const current = status[missionId] || 0;
                const total = missionDetails[missionId].total;
                const title = missionDetails[missionId].title;
                const isCompleted = current >= total;
                const percentage = (current / total) * 100;

                const div = document.createElement('div');
                div.className = `checklist-item ${isCompleted ? 'completed' : ''}`;
                div.innerHTML = `
                    <div class="checklist-content">
                        <div class="checklist-title">${title}</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${percentage}%; ${isCompleted ? 'background: #10b981;' : ''}"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ${current} / ${total} ${isCompleted ? '✓ הושלם' : ''}
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="check-button" onclick="incrementAdminProgress('${missionId}')" ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? 'הושלם' : '+ סימון'}
                        </button>
                        <button class="reset-button" onclick="resetAdminTask('${missionId}')">
                            איפוס
                        </button>
                    </div>
                `;
                checklistDiv.appendChild(div);
            });

            updateOverallProgress('admin', status);
        }

        window.incrementAdminProgress = async function(missionId) {
            if (!selectedKatagisId) return;

            const katagisData = await getIdData(selectedKatagisId);
            const current = katagisData.status[missionId] || 0;
            const total = missionDetails[missionId].total;

            if (current < total) {
                const updates = {};
                updates[`${selectedKatagisId}/status/${missionId}`] = current + 1;
                await update(ref(db), updates);
                
                // Refresh data
                allKatagisData[selectedKatagisId] = await getIdData(selectedKatagisId);
                showAdminDetail(selectedKatagisId);
            }
        };

        window.resetAdminTask = async function(missionId) {
            if (!selectedKatagisId) return;

            const title = missionDetails[missionId].title;
            if (confirm(`האם לאפס את ההתקדמות במשימה: "${title}"?`)) {
                const updates = {};
                updates[`${selectedKatagisId}/status/${missionId}`] = 0;
                await update(ref(db), updates);
                
                // Refresh data
                allKatagisData[selectedKatagisId] = await getIdData(selectedKatagisId);
                showAdminDetail(selectedKatagisId);
            }
        };

        // Helper Functions
        function calculateProgress(status) {
            let totalItems = 0;
            let completedItems = 0;

            missions.forEach(missionId => {
                const current = status[missionId] || 0;
                const total = missionDetails[missionId].total;
                totalItems += total;
                completedItems += current;
            });

            return totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
        }

        function updateOverallProgress(view, status) {
            const percentage = calculateProgress(status);
            
            let barId, textId, countId;
            if (view === 'katagis') {
                barId = 'overallProgressBar';
                textId = 'overallProgressText';
                countId = 'checklistCount';
            } else if (view === 'rakaz') {
                barId = 'rakazOverallProgressBar';
                textId = 'rakazOverallProgressText';
                countId = 'rakazChecklistCount';
            } else if (view === 'admin') {
                barId = 'adminOverallProgressBar';
                textId = 'adminOverallProgressText';
                countId = 'adminChecklistCount';
            }

            document.getElementById(barId).style.width = percentage + '%';
            document.getElementById(textId).textContent = percentage + '%';
            document.getElementById(countId).textContent = missions.length;
        }

        function showLoading(show) {
            document.getElementById('loadingMessage').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('loginError').classList.add('hidden');
        }

        // Initialize on load
        init();
    </script>
</body>
</html>